//@version=6
strategy("BOS Strong Strategy", max_lines_count = 500, overlay = true, calc_on_every_tick = true)

// ================================================================================
// ğŸ”‘ CHIáº¾N LÆ¯á»¢C BOS â†’ OB â†’ ENTRY
// ================================================================================
// 
// TRÃŒNH Tá»° THá»°C HIá»†N:
// 1. BOS (Break of Structure) - XÃ¡c nháº­n xu hÆ°á»›ng má»›i
// 2. OB (Order Block) - TÃ¬m Ä‘iá»ƒm entry tá»‘i Æ°u  
// 3. Entry - VÃ o lá»‡nh khi giÃ¡ retracement vá» OB
//
// CHI TIáº¾T Tá»ªNG BÆ¯á»šC:
//
// ğŸ“ BÆ¯á»šC 1: BOS (Break of Structure)
// - BOS xáº£y ra khi giÃ¡ phÃ¡ swing high/low quan trá»ng
// - ÄÃ¢y chá»‰ lÃ  xÃ¡c nháº­n xu hÆ°á»›ng má»›i hÃ¬nh thÃ nh, CHÆ¯A ENTRY
// - BOS xuá»‘ng = giÃ¡ Ä‘Ã³ng cá»­a phÃ¡ swing low gáº§n nháº¥t
// - BOS lÃªn = giÃ¡ Ä‘Ã³ng cá»­a phÃ¡ swing high gáº§n nháº¥t
//
// ğŸ“ BÆ¯á»šC 2: TÃ¬m OB (Order Block) 
// - Sau khi cÃ³ BOS, tÃ¬m OB gáº§n nháº¥t theo hÆ°á»›ng BOS
// - Náº¿u BOS xuá»‘ng â†’ chá»n Bearish OB (cÃ¢y bullish cuá»‘i cÃ¹ng trÆ°á»›c cÃº giáº£m máº¡nh)
// - Náº¿u BOS lÃªn â†’ chá»n Bullish OB (cÃ¢y bearish cuá»‘i cÃ¹ng trÆ°á»›c cÃº tÄƒng máº¡nh)
//
// ğŸ“ BÆ¯á»šC 3: Entry Point
// - Äá»£i giÃ¡ há»“i (retracement) vá» OB Ä‘Ã³
// - ÄÃ¢y chÃ­nh lÃ  Ä‘iá»ƒm "entry vÃ ng"
// - ThÆ°á»ng Ä‘áº·t limit order táº¡i vÃ¹ng OB (hoáº·c wick cá»§a OB)
// - âš ï¸ QUAN TRá»ŒNG: KhÃ´ng entry ngay khi vá»«a cÃ³ BOS
//
// ğŸ“ RISK MANAGEMENT:
// - SL Ä‘áº·t ngoÃ i OB (trÃªn cho short, dÆ°á»›i cho long)
// - TP theo R:R (1:1 máº·c Ä‘á»‹nh)
//
// ================================================================================

// === Strategy Settings ===
// BOS Strong Entry Settings
showBOSSignals = input.bool(true, title="Show BOS Signals", group="BOS Entry")
showSLTP = input.bool(true, title="Show SL/TP Levels", group="Risk Management")
showOBZones = input.bool(true, title="Show Order Block Zones", group="BOS Entry")
waitForRetracement = input.bool(true, title="Wait for OB Retracement", group="BOS Entry")
retracementThreshold = input.float(0.5, title="Retracement Threshold", minval=0.1, maxval=1.0, step=0.1, group="BOS Entry")

// Risk Management Settings
slLookback = input.int(50, title="SL Lookback (bars)", minval=10, maxval=200, group="Risk Management")
tpRatio = input.float(1, title="TP Ratio (vs SL)", minval=0.1, maxval=2.0, step=0.1, group="Risk Management")

// === Constants ===
BULLISH = +1
BEARISH = -1
BOS = "BOS"
CHOCH = "CHOCH"

GREEN = #089981
RED = #F23645
BLUE = #2157f3
GRAY = #878b94

// === Data Structures ===
type pivot
    float currentLevel
    float lastLevel
    bool crossed
    int barTime
    int barIndex

type trend
    int bias

type orderBlock
    float high
    float low
    int barIndex
    int direction  // 1 for bullish OB, -1 for bearish OB
    bool active
    bool touched

type bosState
    bool bullishBOS
    bool bearishBOS
    float obHigh
    float obLow
    bool waitingForRetracement

// === Variables ===
var pivot swingHigh = pivot.new(na, na, false, time, bar_index)
var pivot swingLow = pivot.new(na, na, false, time, bar_index)
var trend swingTrend = trend.new(0)
var bosState currentBOS = bosState.new(false, false, na, na, false)
var orderBlock currentOB = orderBlock.new(na, na, na, 0, false, false)

// === Smart Money Functions ===
// Leg detection function
leg(int size) =>
    var leg = 0
    newLegHigh = high[size] > ta.highest(high, size)
    newLegLow = low[size] < ta.lowest(low, size)
    
    if newLegHigh
        leg := 0  // Bearish leg
    else if newLegLow
        leg := 1  // Bullish leg
    leg

startOfNewLeg(int leg) => ta.change(leg) != 0
startOfBearishLeg(int leg) => ta.change(leg) == -1
startOfBullishLeg(int leg) => ta.change(leg) == +1

// Get current structure
getCurrentStructure(int size) =>
    currentLeg = leg(size)
    newPivot = startOfNewLeg(currentLeg)
    pivotLow = startOfBullishLeg(currentLeg)
    pivotHigh = startOfBearishLeg(currentLeg)

    if newPivot
        if pivotLow
            swingLow.lastLevel := swingLow.currentLevel
            swingLow.currentLevel := low[size]
            swingLow.crossed := false
            swingLow.barTime := time[size]
            swingLow.barIndex := bar_index[size]
        else
            swingHigh.lastLevel := swingHigh.currentLevel
            swingHigh.currentLevel := high[size]
            swingHigh.crossed := false
            swingHigh.barTime := time[size]
            swingHigh.barIndex := bar_index[size]



// === BOS Detection ===
// ================================================================================
// ğŸ¯ BOS DETECTION LOGIC
// ================================================================================
// Theo chiáº¿n lÆ°á»£c BOS â†’ OB â†’ Entry:
// 1. PhÃ¡t hiá»‡n khi giÃ¡ phÃ¡ swing high/low quan trá»ng
// 2. XÃ¡c nháº­n báº±ng cÃ¢y náº¿n máº¡nh (strong bar)  
// 3. ÄÃ¡nh dáº¥u xu hÆ°á»›ng má»›i nhÆ°ng CHÆ¯A ENTRY
// 4. Chá» retracement vá» OB Ä‘á»ƒ entry
// ================================================================================

// Check for strong bullish/bearish bars
isStrongBullishBar() =>
    bodySize = math.abs(close - open)
    upperWick = high - math.max(close, open)
    lowerWick = math.min(close, open) - low
    
    // Strong bullish: body > 60% of total range, small upper wick
    totalRange = high - low
    bodyRatio = bodySize / totalRange
    upperWickRatio = upperWick / totalRange
    
    bodyRatio > 0.5 and upperWickRatio < 0.4

isStrongBearishBar() =>
    bodySize = math.abs(close - open)
    upperWick = high - math.max(close, open)
    lowerWick = math.min(close, open) - low
    
    // Strong bearish: body > 60% of total range, small lower wick
    totalRange = high - low
    bodyRatio = bodySize / totalRange
    lowerWickRatio = lowerWick / totalRange
    
    bodyRatio > 0.5 and lowerWickRatio < 0.4




// Check for weak bullish/bearish bars (any bullish/bearish bar)
isWeakBullishBar() =>
    close > open

isWeakBearishBar() =>
    close < open

// ================================================================================
// ğŸ¯ ORDER BLOCK DETECTION FUNCTIONS
// ================================================================================
// TÃ¬m Order Block theo chiáº¿n lÆ°á»£c BOS â†’ OB â†’ Entry:
// - Bullish OB: CÃ¢y bearish cuá»‘i cÃ¹ng trÆ°á»›c cÃº tÄƒng máº¡nh
// - Bearish OB: CÃ¢y bullish cuá»‘i cÃ¹ng trÆ°á»›c cÃº giáº£m máº¡nh
// ================================================================================

// TÃ¬m Bullish Order Block (cho entry long sau BOS lÃªn)
findBullishOB() =>
    var float obHigh = na
    var float obLow = na
    var int obIndex = na
    
    // TÃ¬m cÃ¢y bearish cuá»‘i cÃ¹ng trÆ°á»›c cÃº tÄƒng máº¡nh
    for i = 1 to 50
        if close[i] < open[i] and close[i-1] > open[i-1]  // CÃ¢y bearish sau cÃ¢y bullish
            // Kiá»ƒm tra cÃ³ cÃº tÄƒng máº¡nh sau Ä‘Ã³ khÃ´ng
            hasStrongRise = false
            for j = 0 to i-1
                if close[j] > high[i] and isStrongBullishBar()
                    hasStrongRise := true
                    break
            
            if hasStrongRise
                obHigh := high[i]
                obLow := low[i]
                obIndex := bar_index[i]
                break
    
    [obHigh, obLow, obIndex]

// TÃ¬m Bearish Order Block (cho entry short sau BOS xuá»‘ng)  
findBearishOB() =>
    var float obHigh = na
    var float obLow = na
    var int obIndex = na
    
    // TÃ¬m cÃ¢y bullish cuá»‘i cÃ¹ng trÆ°á»›c cÃº giáº£m máº¡nh
    for i = 1 to 50
        if close[i] > open[i] and close[i-1] < open[i-1]  // CÃ¢y bullish sau cÃ¢y bearish
            // Kiá»ƒm tra cÃ³ cÃº giáº£m máº¡nh sau Ä‘Ã³ khÃ´ng
            hasStrongDrop = false
            for j = 0 to i-1
                if close[j] < low[i] and isStrongBearishBar()
                    hasStrongDrop := true
                    break
                    
            if hasStrongDrop
                obHigh := high[i]
                obLow := low[i] 
                obIndex := bar_index[i]
                break
    
    [obHigh, obLow, obIndex]

// Kiá»ƒm tra giÃ¡ cÃ³ retracement vá» OB zone khÃ´ng
isPriceInOBZone(float obHigh, float obLow) =>
    low <= obHigh and high >= obLow

// ================================================================================
// ğŸš¨ BOS SIGNAL DETECTION
// ================================================================================
// LOGIC THEO CHIáº¾N LÆ¯á»¢C:
// - BOS lÃªn: giÃ¡ Ä‘Ã³ng cá»­a phÃ¡ swing high gáº§n nháº¥t + cÃ¢y náº¿n máº¡nh
// - BOS xuá»‘ng: giÃ¡ Ä‘Ã³ng cá»­a phÃ¡ swing low gáº§n nháº¥t + cÃ¢y náº¿n máº¡nh  
// - ÄÃ¢y chá»‰ lÃ  bÆ°á»›c 1 - XÃC NHáº¬N xu hÆ°á»›ng má»›i
// - Sau BOS â†’ tÃ¬m OB gáº§n nháº¥t â†’ chá» retracement Ä‘á»ƒ entry
// ================================================================================
detectBOSSignals() =>
    bullishBOSStrong = false
    bearishBOSStrong = false
    
    // ğŸ“ˆ BOS LÃŠN: GiÃ¡ phÃ¡ swing high + cÃ¢y náº¿n bullish máº¡nh
    // â†’ Xu hÆ°á»›ng tÄƒng má»›i, tÃ¬m Bullish OB vÃ  chá» retracement
    if ta.crossover(close, swingHigh.currentLevel) and not swingHigh.crossed and isStrongBullishBar()
        signalType = swingTrend.bias == BEARISH ? CHOCH : BOS
        
        if signalType == BOS
            bullishBOSStrong := true
            swingHigh.crossed := true
            swingTrend.bias := BULLISH
            
            // TÃ¬m Bullish OB vÃ  setup Ä‘á»ƒ chá» retracement
            [obHigh, obLow, obIndex] = findBullishOB()
            if not na(obHigh) and not na(obLow)
                currentBOS.bullishBOS := true
                currentBOS.bearishBOS := false
                currentBOS.obHigh := obHigh
                currentBOS.obLow := obLow
                currentBOS.waitingForRetracement := true
                
                currentOB.high := obHigh
                currentOB.low := obLow
                currentOB.barIndex := obIndex
                currentOB.direction := 1  // Bullish OB
                currentOB.active := true
                currentOB.touched := false
    
    // ğŸ“‰ BOS XUá»NG: GiÃ¡ phÃ¡ swing low + cÃ¢y náº¿n bearish máº¡nh  
    // â†’ Xu hÆ°á»›ng giáº£m má»›i, tÃ¬m Bearish OB vÃ  chá» retracement
    if ta.crossunder(close, swingLow.currentLevel) and not swingLow.crossed and isStrongBearishBar()
        signalType = swingTrend.bias == BULLISH ? CHOCH : BOS
        
        if signalType == BOS
            bearishBOSStrong := true
            swingLow.crossed := true
            swingTrend.bias := BEARISH
            
            // TÃ¬m Bearish OB vÃ  setup Ä‘á»ƒ chá» retracement
            [obHigh, obLow, obIndex] = findBearishOB()
            if not na(obHigh) and not na(obLow)
                currentBOS.bullishBOS := false
                currentBOS.bearishBOS := true
                currentBOS.obHigh := obHigh
                currentBOS.obLow := obLow
                currentBOS.waitingForRetracement := true
                
                currentOB.high := obHigh
                currentOB.low := obLow
                currentOB.barIndex := obIndex
                currentOB.direction := -1  // Bearish OB
                currentOB.active := true
                currentOB.touched := false
    
    [bullishBOSStrong, bearishBOSStrong]

// === Risk Management Functions ===
// Calculate TP based on 100% of SL distance
calculateTP(float entryPrice, float slPrice, bool isLong) =>
    slDistance = math.abs(entryPrice - slPrice)
    tpDistance = slDistance * tpRatio
    
    if isLong
        entryPrice + tpDistance
    else
        entryPrice - tpDistance

// === Main Execution ===
// Update structure
getCurrentStructure(50)  // Swing structure

// Detect BOS signals
[bullishBOSStrong, bearishBOSStrong] = detectBOSSignals()

// ================================================================================
// ğŸ¯ ORDER BLOCK (OB) LOGIC - BÆ¯á»šC 2 Cá»¦A CHIáº¾N LÆ¯á»¢C
// ================================================================================
// CÃCH HOáº T Äá»˜NG:
// 1. Sau khi cÃ³ BOS, tÃ¬m OB gáº§n nháº¥t theo hÆ°á»›ng BOS
// 2. BOS xuá»‘ng â†’ Bearish OB (cÃ¢y bullish cuá»‘i cÃ¹ng trÆ°á»›c cÃº giáº£m máº¡nh)
// 3. BOS lÃªn â†’ Bullish OB (cÃ¢y bearish cuá»‘i cÃ¹ng trÆ°á»›c cÃº tÄƒng máº¡nh)  
// 4. Äá»£i giÃ¡ retracement vá» vÃ¹ng OB nÃ y Ä‘á»ƒ entry
// 5. SL Ä‘áº·t ngoÃ i OB (trÃªn cho short, dÆ°á»›i cho long)
// ================================================================================

m5High = request.security(syminfo.tickerid, "5", high)
m5Low = request.security(syminfo.tickerid, "5", low)
m5Volume = request.security(syminfo.tickerid, "5", volume)

// XÃ¡c Ä‘á»‹nh Order Block tá»« timeframe 5M
m5OBHigh = request.security(syminfo.tickerid, "5", ta.highest(high, 50))
m5OBLow = request.security(syminfo.tickerid, "5", ta.lowest(low, 50))

// ğŸ¯ SL LEVELS - Theo nguyÃªn táº¯c OB
longSLLevel = m5OBLow    // SL cho long = dÆ°á»›i OB (tháº¥p nháº¥t cá»§a OB 5M)
shortSLLevel = m5OBHigh  // SL cho short = trÃªn OB (cao nháº¥t cá»§a OB 5M)

// ================================================================================
// ğŸš€ STRATEGY EXECUTION - BÆ¯á»šC 3: ENTRY POINT (Cáº¢I THIá»†N)
// ================================================================================
// âœ… LOGIC ENTRY THEO CHIáº¾N LÆ¯á»¢C BOS â†’ OB â†’ ENTRY CHUáº¨N:
// 1. âœ… PhÃ¡t hiá»‡n BOS â†’ ÄÃ¡nh dáº¥u xu hÆ°á»›ng má»›i
// 2. âœ… TÃ¬m OB gáº§n nháº¥t theo hÆ°á»›ng BOS  
// 3. âœ… Chá» giÃ¡ retracement vá» vÃ¹ng OB
// 4. âœ… Entry khi giÃ¡ touch OB zone (Ä‘iá»ƒm entry vÃ ng)
// 
// ğŸ¯ RISK MANAGEMENT:
// - SL: NgoÃ i OB (dÆ°á»›i cho long, trÃªn cho short)
// - TP: Theo R:R ratio (máº·c Ä‘á»‹nh 1:1)
// ================================================================================

// Kiá»ƒm tra retracement vá» OB zone sau BOS
if currentBOS.waitingForRetracement and currentOB.active
    inOBZone = isPriceInOBZone(currentOB.high, currentOB.low)
    
    // âœ… Entry khi giÃ¡ retracement vá» OB zone
    if inOBZone and not currentOB.touched
        currentOB.touched := true
        
        // ğŸ“ˆ LONG ENTRY: Sau BOS lÃªn vÃ  retracement vá» Bullish OB
        if currentBOS.bullishBOS and strategy.position_size <= 0
            entryPrice = close
            slPrice = currentOB.low  // SL dÆ°á»›i OB
            tpPrice = calculateTP(entryPrice, slPrice, true)
            
            strategy.entry("Long OB Retracement", strategy.long)
            strategy.exit("Long OB Exit", "Long OB Retracement", stop=slPrice, limit=tpPrice)
            
            if showBOSSignals
                label.new(bar_index, low, text="ENTRY\nOB\nLONG", color=color.green, style=label.style_label_up, size=size.small)
            
            // Reset BOS state after entry
            currentBOS.waitingForRetracement := false
            currentOB.active := false
        
        // ğŸ“‰ SHORT ENTRY: Sau BOS xuá»‘ng vÃ  retracement vá» Bearish OB
        if currentBOS.bearishBOS and strategy.position_size >= 0
            entryPrice = close
            slPrice = currentOB.high  // SL trÃªn OB  
            tpPrice = calculateTP(entryPrice, slPrice, false)
            
            strategy.entry("Short OB Retracement", strategy.short)
            strategy.exit("Short OB Exit", "Short OB Retracement", stop=slPrice, limit=tpPrice)
            
            if showBOSSignals
                label.new(bar_index, high, text="ENTRY\nOB\nSHORT", color=color.red, style=label.style_label_down, size=size.small)
            
            // Reset BOS state after entry
            currentBOS.waitingForRetracement := false
            currentOB.active := false

// ğŸ”„ Hiá»ƒn thá»‹ BOS signals (chá»‰ Ä‘á»ƒ thÃ´ng bÃ¡o, khÃ´ng entry ngay)
if bullishBOSStrong and showBOSSignals
    label.new(bar_index, low, text="BOSâ†—\nWAIT OB", color=color.blue, style=label.style_label_up, size=size.normal)

if bearishBOSStrong and showBOSSignals  
    label.new(bar_index, high, text="BOSâ†˜\nWAIT OB", color=color.orange, style=label.style_label_down, size=size.normal)

// === Plots ===
// Calculate TP levels for plotting
longTPLevel = strategy.position_size > 0 ? calculateTP(strategy.position_avg_price, longSLLevel, true) : na
shortTPLevel = strategy.position_size < 0 ? calculateTP(strategy.position_avg_price, shortSLLevel, false) : na

// Plot current SL levels for reference
plot(showSLTP and strategy.position_size > 0 ? longSLLevel : na, "Long SL Level", color.red, 2, plot.style_stepline)
plot(showSLTP and strategy.position_size < 0 ? shortSLLevel : na, "Short SL Level", color.red, 2, plot.style_stepline)

// Plot current TP levels for reference
plot(longTPLevel, "Long TP Level", color.green, 2, plot.style_stepline)
plot(shortTPLevel, "Short TP Level", color.green, 2, plot.style_stepline)

// ================================================================================
// ğŸ“Š ORDER BLOCK ZONE VISUALIZATION
// ================================================================================
// Hiá»ƒn thá»‹ vÃ¹ng OB Ä‘ang chá» retracement
// ================================================================================

// Plot Order Block zones
obHighLevel = currentOB.active ? currentOB.high : na
obLowLevel = currentOB.active ? currentOB.low : na

plot(showOBZones and currentOB.active ? obHighLevel : na, "OB High", color.new(color.purple, 50), 2, plot.style_stepline)
plot(showOBZones and currentOB.active ? obLowLevel : na, "OB Low", color.new(color.purple, 50), 2, plot.style_stepline)

// Fill OB zone
obZoneFill = fill(plot(showOBZones and currentOB.active ? obHighLevel : na, color=na), 
                  plot(showOBZones and currentOB.active ? obLowLevel : na, color=na), 
                  color=color.new(currentOB.direction > 0 ? color.green : color.red, 90),
                  title="OB Zone")

// ================================================================================
// ğŸ‰ CHIáº¾N LÆ¯á»¢C BOS â†’ OB â†’ ENTRY ÄÃƒ HOÃ€N THIá»†N
// ================================================================================
// âœ… SCRIPT ÄÃƒ Cáº¢I THIá»†N HOÃ€N TOÃ€N:
// 1. âœ… BOS Detection - PhÃ¡t hiá»‡n khi giÃ¡ phÃ¡ swing high/low vá»›i cÃ¢y náº¿n máº¡nh
// 2. âœ… Order Block Detection - TÃ¬m cÃ¢y náº¿n cá»¥ thá»ƒ lÃ m OB theo Ä‘Ãºng methodology
//    â€¢ Bullish OB: CÃ¢y bearish cuá»‘i trÆ°á»›c cÃº tÄƒng máº¡nh (cho long entry)  
//    â€¢ Bearish OB: CÃ¢y bullish cuá»‘i trÆ°á»›c cÃº giáº£m máº¡nh (cho short entry)
// 3. âœ… Retracement Logic - Chá» giÃ¡ há»“i vá» OB zone rá»“i má»›i entry
// 4. âœ… Risk Management - SL ngoÃ i OB, TP theo R:R 1:1
// 5. âœ… Visual Signals - Hiá»ƒn thá»‹ BOS, OB zones, entry points
// 6. âœ… Settings Panel - TÃ¹y chá»‰nh cÃ¡c tham sá»‘ strategy
//
// ğŸ¯ CÃCH HOáº T Äá»˜NG THEO CHIáº¾N LÆ¯á»¢C CHUáº¨N:
// 1. ğŸ” PhÃ¡t hiá»‡n BOS â†’ Hiá»ƒn thá»‹ "BOSâ†— WAIT OB" hoáº·c "BOSâ†˜ WAIT OB"
// 2. ğŸ¯ TÃ¬m OB gáº§n nháº¥t theo hÆ°á»›ng BOS â†’ Hiá»ƒn thá»‹ vÃ¹ng OB mÃ u tÃ­m
// 3. â³ Chá» giÃ¡ retracement vá» vÃ¹ng OB (Ä‘iá»ƒm entry vÃ ng)
// 4. ğŸš€ Entry khi giÃ¡ touch OB â†’ Hiá»ƒn thá»‹ "ENTRY OB LONG/SHORT"
// 5. ğŸ“Š SL Ä‘áº·t ngoÃ i OB, TP theo R:R ratio
//
// ğŸ® SETTINGS AVAILABLE:
// â€¢ Show BOS Signals, Show OB Zones, Show SL/TP
// â€¢ Wait for Retracement (báº­t/táº¯t chá» retracement)
// â€¢ Retracement Threshold, TP Ratio
//
// ğŸ’ ÄIá»‚M Máº NH Cá»¦A STRATEGY:
// â€¢ KhÃ´ng entry ngay khi cÃ³ BOS (trÃ¡nh fakeout)
// â€¢ Chá» retracement vá» OB Ä‘á»ƒ cÃ³ entry price tá»‘t hÆ¡n
// â€¢ Risk management cháº·t cháº½ vá»›i SL ngoÃ i OB
// â€¢ Visual clear giÃºp theo dÃµi signals dá»… dÃ ng
// ================================================================================